#========================================================================
#
# JNI Adapter Makefile
#
# Copyright 2013 Joseph Beard
#
#========================================================================

SHELL = /bin/sh

prefix = @prefix@
srcdir = @srcdir@
VPATH = @srcdir@

GOOSRCDIR = $(srcdir)/../goo
GOOLIBDIR = ../goo
FOFISRCDIR = $(srcdir)/../fofi
FOFILIBDIR = ../fofi
SPLASHSRCDIR = $(srcdir)/../splash
SPLASHLIBDIR = ../splash
XPDFSRCDIR = $(srcdir)/../xpdf
XPDFLIBDIR = ../xpdf

JAVA_HOME = @JAVA_HOME@
JDKHEADERS = @JDKHEADERS@

CXXFLAGS = @CXXFLAGS@ @DEFS@ -I.. -I$(GOOSRCDIR) -I$(FOFISRCDIR) -I$(SPLASHSRCDIR) -I$(XPDFSRCDIR) $(JDKHEADERS) -I$(srcdir) @freetype2_CFLAGS@ @Sgm_CFLAGS@ @Xm_CFLAGS@ @Xt_CFLAGS@ @Xp_CFLAGS@ @Xext_CFLAGS@ @Xpm_CFLAGS@ @t1_CFLAGS@ @libpaper_CFLAGS@ @X_CFLAGS@

LDFLAGS = @LDFLAGS@

T1LIBS = @t1_LIBS@
FTLIBS = @freetype2_LIBS@

OTHERLIBS = @LIBS@ \
	-L$(GOOLIBDIR) -lGoo \
	-L$(FOFILIBDIR) -lfofi \
	-L$(SPLASHLIBDIR) -lsplash \
	-L$(XPDFLIBDIR) -lxpdf

CXX = @CXX@
AR = @AR@
RANLIB = @RANLIB@

LIBPREFIX = @LIBPREFIX@
EXE = @EXE@
DLLEXT = @DLLEXT@

#------------------------------------------------------------------------

.SUFFIXES: .cpp

.cpp.o:
	$(CXX) $(CXXFLAGS) -fPIC -c $<

#------------------------------------------------------------------------

CXX_SRC = \
	$(srcdir)/Handle.cpp \
	$(srcdir)/JavaObjectWrapper.cpp \
	$(srcdir)/PDFDocument.cpp \
	$(srcdir)/PDFPage.cpp \
	$(srcdir)/TextCollector.cpp

#------------------------------------------------------------------------

all: $(LIBPREFIX)xpdf-jni.a $(LIBPREFIX)xpdf-jni$(DLLEXT) test

#------------------------------------------------------------------------

JNI_OBJS = \
	Handle.o \
	JavaObjectWrapper.o \
	PDFDocument.o \
	PDFPage.o \
	TextCollector.o

JNI_LIBS = $(T1LIBS) $(FTLIBS) $(XLIBS) $(OTHERLIBS) -lm

$(LIBPREFIX)xpdf-jni.a: $(JNI_OBJS)
	rm -f $(LIBPREFIX)xpdf-jni.a
	$(AR) $(LIBPREFIX)xpdf-jni.a $(JNI_OBJS)
	$(RANLIB) $(LIBPREFIX)xpdf-jni.a

#------------------------------------------------------------------------

DLL_LIBS = \
	$(GOOLIBDIR)/$(LIBPREFIX)Goo.a \
	$(FOFILIBDIR)/$(LIBPREFIX)fofi.a \
	$(SPLASHLIBDIR)/$(LIBPREFIX)splash.a \
	$(XPDFLIBDIR)/$(LIBPREFIX)xpdf.a \
	$(LIBPREFIX)xpdf-jni.a

$(LIBPREFIX)xpdf-jni$(DLLEXT): $(DLL_LIBS)
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -shared -o $@ -Wl,--whole-archive $(DLL_LIBS) -Wl,--no-whole-archive

#------------------------------------------------------------------------

TEST_OBJS = test.o

test$(EXE): $(TEST_OBJS) $(LIBPREFIX)xpdf-jni$(DLLEXT)
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ test.o -L. -lxpdf-jni

#------------------------------------------------------------------------

clean:
	rm -f $(JNI_OBJS) $(LIBPREFIX)xpdf-jni.a
	rm -f $(LIBPREFIX)xpdf-jni$(DLLEXT)
	rm -f $(TEST_OBJS) test$(EXE)

#------------------------------------------------------------------------

depend:
	$(CXX) $(CXXFLAGS) -MM $(CXX_SRC) >Makefile.dep

include Makefile.dep
